<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Poultry — Purchase Orders</title>
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --accent:#1565c0; --muted:#6b7280;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    body{ margin:0; background:linear-gradient(180deg,#eef2ff 0%, var(--bg) 100%); color:#0f172a; }
    .wrap{ max-width:1100px; margin:28px auto; padding:20px; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px }
    h1{ margin:0; font-size:20px; }
    .card{ background:var(--card); border-radius:12px; padding:16px; box-shadow:0 6px 18px rgba(12,20,40,0.06); }
    form .row{ display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input[type="text"], input[type="date"], input[type="number"], select, textarea{
      width:100%; padding:10px 12px; border:1px solid #e6edf3; border-radius:8px;
      font-size:14px; color: #0f172a; background:transparent;
    }
    .col{ flex:1; min-width:160px; }
    .col.w-40{ flex:0 0 40%; }
    .col.w-30{ flex:0 0 30%; }
    .col.w-20{ flex:0 0 20%; }
    .items-table{ width:100%; border-collapse:collapse; margin-top:10px; }
    .items-table th, .items-table td{ padding:8px 10px; border-bottom:1px solid #f1f5f9; text-align:left; font-size:14px }
    .items-table th{ font-size:13px; color:var(--muted); font-weight:600; }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
    .btn-primary{ background:var(--accent); color:white; }
    .btn-ghost{ background:transparent; border:1px solid #e6edf3; color:var(--muted); }
    .btn-danger{ background:#ef4444; color:white; }
    .muted{ color:var(--muted); font-size:13px; }
    .calc{ display:flex; gap:12px; justify-content:flex-end; margin-top:12px; }
    .calc .box{ background:#fafbff; padding:10px 12px; border-radius:8px; min-width:200px; text-align:right; }
    .signs{ display:flex; gap:12px; margin-top:16px; flex-wrap:wrap; }
    .sign{ flex:1; min-width:180px; background:#fff; padding:10px; border-radius:8px; border:1px dashed #e6edf3; text-align:center; }
    .po-list{ margin-top:18px; }
    .po-item{ padding:10px; border-radius:8px; margin-bottom:8px; display:flex; justify-content:space-between; gap:8px; align-items:center; }
    .tag{ font-size:12px; padding:6px 8px; border-radius:999px; background:#eef2ff; color: var(--accent); font-weight:600; }
    small{ color:var(--muted) }
    .right{ text-align:right }
    .actions{ display:flex; gap:8px; }
    @media (max-width:860px){
      .col.w-40, .col.w-30, .col.w-20 { flex:1 1 100%; }
      .calc{ flex-direction:column; align-items:flex-end; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Purchase Order — Poultry Farm</h1>
        <small class="muted">Create and manage POs for multiple farms</small>
      </div>
      <div>
        <button id="btnNew" class="btn btn-primary">New PO</button>
        <button id="btnRefresh" class="btn btn-ghost">Refresh List</button>
      </div>
    </header>

    <div id="mainCard" class="card">
      <form id="poForm" onsubmit="return false;">
        <div style="display:flex; gap:12px; align-items:center; margin-bottom:8px; flex-wrap:wrap">
          <div class="col w-20">
            <label>PO Number</label>
            <input type="text" id="po_number" readonly placeholder="(will be generated on save)" />
          </div>
          <div class="col w-20">
            <label>PO Date</label>
            <input type="date" id="po_date" />
          </div>
          <div class="col w-40">
            <label>FOR (Farm or Person)</label>
            <input type="text" id="for_name" placeholder="e.g., Farm #3 — Memon Goth or Umer (Supervisor)" />
          </div>
          <div class="col w-20">
            <label>Status</label>
            <input type="text" id="status" readonly value="draft" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Supplier</label>
            <select id="supplier_select"></select>
            <small class="muted">Or choose "Manual / New" and fill supplier fields.</small>
          </div>
          <div class="col">
            <label>Supplier Name (manual)</label>
            <input type="text" id="supplier_name" placeholder="Supplier full name" />
          </div>
          <div class="col">
            <label>Contact</label>
            <input type="text" id="supplier_contact" placeholder="phone / email" />
          </div>
          <div class="col">
            <label>Address</label>
            <input type="text" id="supplier_address" placeholder="Supplier address" />
          </div>
        </div>

        <div class="row" style="align-items:center">
          <div style="flex:1">
            <label>Items</label>
            <table class="items-table" id="itemsTable">
              <thead>
                <tr>
                  <th style="width:48px">#</th>
                  <th>Product Name</th>
                  <th style="width:90px">Unit</th>
                  <th style="width:110px">Quantity</th>
                  <th style="width:130px">Unit Price</th>
                  <th style="width:130px">Total</th>
                  <th style="width:80px"></th>
                </tr>
              </thead>
              <tbody id="itemsBody"></tbody>
            </table>

            <div style="margin-top:8px">
              <button id="addItemBtn" type="button" class="btn btn-ghost">+ Add Item</button>
            </div>
          </div>
        </div>

        <div class="row" style="justify-content:flex-end; gap:10px; margin-top:12px">
          <div style="flex:0 0 300px">
            <label>Remarks</label>
            <textarea id="remarks" rows="3" style="width:100%"></textarea>
          </div>

          <div style="flex:0 0 320px">
            <div class="calc">
              <div class="box" style="text-align:left">
                <div class="muted">Subtotal</div>
                <div id="subtotal" style="font-weight:700; font-size:16px">0.00</div>
              </div>
            </div>

            <div class="row" style="margin-top:8px">
              <div class="col">
                <label>Tax (%)</label>
                <input type="number" id="taxPct" value="0" min="0" />
              </div>
              <div class="col">
                <label>Freight / Other</label>
                <input type="number" id="freight" value="0" min="0" />
              </div>
            </div>

            <div style="margin-top:8px" class="right">
              <div class="muted">Tax amount</div>
              <div id="taxAmount" style="font-weight:700">0.00</div>
              <div class="muted">Final Total</div>
              <div id="finalTotal" style="font-weight:900; font-size:18px">0.00</div>
            </div>
          </div>
        </div>

        <div class="signs">
          <div class="sign">
            <small class="muted">Prepared By</small>
            <input type="text" id="prepared_by" placeholder="Name" style="margin-top:8px" />
            <div style="margin-top:6px"><small id="prepared_time" class="muted"></small></div>
          </div>
          <div class="sign">
            <small class="muted">Finance Approval</small>
            <input type="text" id="finance_by" placeholder="Name" style="margin-top:8px" />
            <div style="margin-top:6px" class="actions">
              <button id="btnFinanceApprove" type="button" class="btn btn-primary">Approve Finance</button>
              <button id="btnFinanceClear" type="button" class="btn btn-ghost">Clear</button>
            </div>
            <div style="margin-top:6px"><small id="finance_time" class="muted"></small></div>
          </div>
          <div class="sign">
            <small class="muted">Director Approval</small>
            <input type="text" id="director_by" placeholder="Name" style="margin-top:8px" />
            <div style="margin-top:6px" class="actions">
              <button id="btnDirectorApprove" type="button" class="btn btn-primary">Approve Director</button>
              <button id="btnDirectorClear" type="button" class="btn btn-ghost">Clear</button>
            </div>
            <div style="margin-top:6px"><small id="director_time" class="muted"></small></div>
          </div>
        </div>

        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px">
          <button id="btnSave" type="button" class="btn btn-primary">Save & Submit</button>
          <button id="btnSaveDraft" type="button" class="btn btn-ghost">Save Draft</button>
          <button id="btnClear" type="button" class="btn btn-danger">Clear Form</button>
        </div>
      </form>
    </div>

    <div class="po-list card" id="poListCard" style="margin-top:18px; padding:12px">
      <h3 style="margin-top:0">Recent Purchase Orders</h3>
      <div id="poList"></div>
    </div>
  </div>

  <!-- Supabase UMD (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
     // ---------- CONFIGURE Supabase ----------
    const SUPABASE_URL = 'https://khwwkgztjoddkveqcree.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtod3drZ3p0am9kZGt2ZXFjcmVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMzA5MjAsImV4cCI6MjA3OTgwNjkyMH0.0Py6OIx_yYvw8mAS8JFqkJX6ZsD3gzdgXYeo2bK9Qds';
    const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    
    // ---------- Helpers ----------
    function moneyFmt(n){ return Number(n).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); }
    function round2(n){ return Math.round((Number(n) + Number.EPSILON) * 100) / 100; }
    function mul(a,b){ return round2( (Math.round(a*100) * Math.round(b*100)) / 10000 ); }
    function escapeHtml(str = '') {
      return String(str).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // ---------- DOM binds ----------
    const itemsBody = document.getElementById('itemsBody');
    const addItemBtn = document.getElementById('addItemBtn');
    const subtotalEl = document.getElementById('subtotal');
    const taxPctEl = document.getElementById('taxPct');
    const freightEl = document.getElementById('freight');
    const taxAmountEl = document.getElementById('taxAmount');
    const finalTotalEl = document.getElementById('finalTotal');
    const poNumberEl = document.getElementById('po_number');
    const poDateEl = document.getElementById('po_date');
    const forNameEl = document.getElementById('for_name');
    const supplierSelect = document.getElementById('supplier_select');
    const supplierNameEl = document.getElementById('supplier_name');
    const supplierContactEl = document.getElementById('supplier_contact');
    const supplierAddressEl = document.getElementById('supplier_address');
    const remarksEl = document.getElementById('remarks');
    const statusEl = document.getElementById('status');
    const preparedByEl = document.getElementById('prepared_by');
    const financeByEl = document.getElementById('finance_by');
    const directorByEl = document.getElementById('director_by');
    const preparedTimeEl = document.getElementById('prepared_time');
    const financeTimeEl = document.getElementById('finance_time');
    const directorTimeEl = document.getElementById('director_time');
    const btnSave = document.getElementById('btnSave');
    const btnSaveDraft = document.getElementById('btnSaveDraft');
    const btnClear = document.getElementById('btnClear');
    const btnFinanceApprove = document.getElementById('btnFinanceApprove');
    const btnFinanceClear = document.getElementById('btnFinanceClear');
    const btnDirectorApprove = document.getElementById('btnDirectorApprove');
    const btnDirectorClear = document.getElementById('btnDirectorClear');
    const btnNew = document.getElementById('btnNew');
    const btnRefresh = document.getElementById('btnRefresh');
    const poList = document.getElementById('poList');

    let items = [];

    // ---------- Init ----------
    (async function init(){
      setupEventListeners();
      await loadSuppliers();
      await resetForm();
      await loadRecentPOs();
    })();

    function setupEventListeners(){
      addItemBtn.addEventListener('click', addItemRow);
      taxPctEl.addEventListener('input', computeTotals);
      freightEl.addEventListener('input', computeTotals);
      btnSave.addEventListener('click', () => savePO('submitted'));
      btnSaveDraft.addEventListener('click', () => savePO('draft'));
      btnClear.addEventListener('click', resetForm);
      btnFinanceApprove.addEventListener('click', approveFinance);
      btnDirectorApprove.addEventListener('click', approveDirector);
      btnFinanceClear.addEventListener('click', () => { financeByEl.value=''; financeTimeEl.textContent=''; statusEl.value='draft'; });
      btnDirectorClear.addEventListener('click', () => { directorByEl.value=''; directorTimeEl.textContent=''; statusEl.value='draft'; });
      btnNew.addEventListener('click', async () => { await resetForm(); });
      btnRefresh.addEventListener('click', loadRecentPOs);
    }

    // ---------- Suppliers ----------
    async function loadSuppliers(){
      supplierSelect.innerHTML = '<option value="">Loading...</option>';
      try{
        const { data, error } = await supabase.from('suppliers').select('*').order('name',{ascending:true}).limit(500);
        if(error){ console.warn(error); supplierSelect.innerHTML = '<option value="">Manual / New</option>'; return; }
        let html = '<option value="">Manual / New</option>';
        data.forEach(s => {
          html += `<option value="${s.id}" data-contact="${escapeHtml(s.phone||'')}" data-address="${escapeHtml(s.address||'')}">${escapeHtml(s.name)}</option>`;
        });
        supplierSelect.innerHTML = html;
        supplierSelect.addEventListener('change', (e) => {
          const opt = e.target.selectedOptions[0];
          if(!opt) return;
          if(!opt.value){ supplierNameEl.value=''; supplierContactEl.value=''; supplierAddressEl.value=''; return; }
          supplierNameEl.value = opt.text;
          supplierContactEl.value = opt.dataset.contact || '';
          supplierAddressEl.value = opt.dataset.address || '';
        });
      }catch(err){
        console.error(err);
        supplierSelect.innerHTML = '<option value="">Manual / New</option>';
      }
    }

    // ---------- Items ----------
    function addItemRow(item = { product_name:'', unit:'', quantity:0, unit_price:0 }){
      items.push(item);
      renderItems();
    }
    function removeItemRow(index){
      items.splice(index,1);
      renderItems();
    }
    function renderItems(){
      itemsBody.innerHTML = '';
      items.forEach((it, idx) => {
        const tr = document.createElement('tr');
        const total = mul(Number(it.quantity||0), Number(it.unit_price||0));
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td><input data-idx="${idx}" data-field="product_name" class="i-text" value="${escapeHtml(it.product_name||'')}" /></td>
          <td><input data-idx="${idx}" data-field="unit" class="i-text" value="${escapeHtml(it.unit||'')}" /></td>
          <td><input data-idx="${idx}" data-field="quantity" type="number" min="0" class="i-number" value="${it.quantity||0}" /></td>
          <td><input data-idx="${idx}" data-field="unit_price" type="number" min="0" class="i-number" value="${it.unit_price||0}" /></td>
          <td class="right">${moneyFmt(total)}</td>
          <td><button class="btn btn-ghost" data-action="remove" data-idx="${idx}">Remove</button></td>
        `;
        itemsBody.appendChild(tr);
      });

      itemsBody.querySelectorAll('.i-text').forEach(inp => {
        inp.addEventListener('input', (e) => {
          const idx = Number(e.target.dataset.idx);
          const field = e.target.dataset.field;
          items[idx][field] = e.target.value;
          renderItems();
          computeTotals();
        });
      });
      itemsBody.querySelectorAll('.i-number').forEach(inp => {
        inp.addEventListener('input', (e) => {
          const idx = Number(e.target.dataset.idx);
          const field = e.target.dataset.field;
          items[idx][field] = Number(e.target.value || 0);
          renderItems();
          computeTotals();
        });
      });
      itemsBody.querySelectorAll('button[data-action="remove"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          removeItemRow(Number(e.target.dataset.idx));
        });
      });

      computeTotals();
    }

    // ---------- Calculations ----------
    function computeTotals(){
      let subtotal = 0;
      items.forEach(it => {
        subtotal += mul(Number(it.quantity||0), Number(it.unit_price||0));
      });
      subtotal = round2(subtotal);
      subtotalEl.textContent = moneyFmt(subtotal);

      const taxPct = Number(taxPctEl.value || 0);
      const freight = round2(Number(freightEl.value || 0));
      const taxAmount = round2(subtotal * (taxPct / 100));
      taxAmountEl.textContent = moneyFmt(taxAmount);

      const final = round2(subtotal + taxAmount + freight);
      finalTotalEl.textContent = moneyFmt(final);
    }

    // ---------- Save PO ----------
    async function savePO(targetStatus = 'draft'){
      const forName = forNameEl.value.trim();
      const supplier_name = supplierNameEl.value.trim();
      if(!forName){ alert('Please enter FOR (farm or person).'); return; }
      if(items.length === 0 && !confirm('No items added. Save anyway?')) return;

      computeTotals();
      const subtotal = Number(subtotalEl.textContent.replace(/,/g,'')) || 0;
      const tax = Number(taxAmountEl.textContent.replace(/,/g,'')) || 0;
      const freight = round2(Number(freightEl.value || 0));
      const final_total = Number(finalTotalEl.textContent.replace(/,/g,'')) || 0;

      // payload for purchase_orders
      const poPayload = {
        po_date: poDateEl.value || new Date().toISOString().slice(0,10),
        for_name: forName,
        supplier_name,
        supplier_contact: supplierContactEl.value || '',
        supplier_address: supplierAddressEl.value || '',
        subtotal,
        tax,
        freight,
        final_total,
        remarks: remarksEl.value || '',
        prepared_by: preparedByEl.value || '',
        status: targetStatus
      };

      try{
        // Insert PO and return created row (po_number will be generated by DB trigger if configured)
        const { data: poData, error: poErr } = await supabase
          .from('purchase_orders')
          .insert([poPayload])
          .select()
          .single();

        if(poErr){ console.error('PO insert error', poErr); alert('Error saving PO: ' + poErr.message); return; }

        // prepare items rows with computed totals
        const itemRows = items.map((it, idx) => ({
          purchase_order_id: poData.id,
          item_no: idx + 1,
          product_name: it.product_name || '',
          unit: it.unit || '',
          quantity: Number(it.quantity || 0),
          unit_price: Number(it.unit_price || 0),
          total: mul(Number(it.quantity || 0), Number(it.unit_price || 0))
        }));
        if(itemRows.length > 0){
          const { error: itemErr } = await supabase.from('purchase_order_items').insert(itemRows);
          if(itemErr){ console.error('items insert error', itemErr); alert('PO saved but items failed: ' + itemErr.message); return; }
        }

        // update UI with returned data
        poNumberEl.value = poData.po_number || '';
        preparedTimeEl.textContent = new Date(poData.created_at || Date.now()).toLocaleString();
        statusEl.value = poData.status || targetStatus;
        alert('Purchase Order saved: ' + (poData.po_number || '(no number returned)'));
        await loadRecentPOs();
      }catch(e){
        console.error(e);
        alert('Unexpected error: ' + (e.message || e));
      }
    }

    // ---------- Approvals ----------
    async function approveFinance(){
      const name = financeByEl.value.trim();
      if(!name){ alert('Enter finance approver name'); return; }
      const po_number = poNumberEl.value;
      if(!po_number){ alert('No PO loaded. Save first.'); return; }

      try{
        const { data, error } = await supabase.from('purchase_orders').select('*').eq('po_number', po_number).limit(1).single();
        if(error){ alert('PO not found'); return; }
        const { error: upErr } = await supabase.from('purchase_orders').update({
          finance_checked_by: name,
          status: 'finance_approved'
        }).eq('id', data.id);
        if(upErr){ alert('Approve error: ' + upErr.message); return; }
        financeTimeEl.textContent = new Date().toLocaleString();
        statusEl.value = 'finance_approved';
        alert('Finance approved.');
        await loadRecentPOs();
      }catch(e){
        console.error(e); alert(e.message || e);
      }
    }

    async function approveDirector(){
      const name = directorByEl.value.trim();
      if(!name){ alert('Enter director name'); return; }
      const po_number = poNumberEl.value;
      if(!po_number){ alert('No PO loaded. Save first.'); return; }

      try{
        const { data, error } = await supabase.from('purchase_orders').select('*').eq('po_number', po_number).limit(1).single();
        if(error){ alert('PO not found'); return; }
        const { error: upErr } = await supabase.from('purchase_orders').update({
          director_approved_by: name,
          status: 'director_approved'
        }).eq('id', data.id);
        if(upErr){ alert('Approve error: ' + upErr.message); return; }
        directorTimeEl.textContent = new Date().toLocaleString();
        statusEl.value = 'director_approved';
        alert('Director approved. PO is now locked.');
        await loadRecentPOs();
      }catch(e){
        console.error(e); alert(e.message || e);
      }
    }

    // ---------- List & load ----------
    async function loadRecentPOs(){
      poList.innerHTML = 'Loading...';
      try{
        const { data, error } = await supabase.from('purchase_orders').select('*').order('created_at',{ascending:false}).limit(30);
        if(error){ poList.innerHTML = 'Failed loading POs'; console.warn(error); return; }
        if(!data || data.length === 0){ poList.innerHTML = '<div class="muted">No POs yet</div>'; return; }
        poList.innerHTML = '';
        data.forEach(p => {
          const div = document.createElement('div');
          div.className = 'po-item';
          div.innerHTML = `
            <div>
              <div style="font-weight:700">${escapeHtml(p.po_number || '(no number)')}</div>
              <div class="muted">${escapeHtml(p.for_name || '')} • ${new Date(p.po_date || p.created_at).toLocaleDateString()}</div>
              <div class="muted">Supplier: ${escapeHtml(p.supplier_name||'')}</div>
            </div>
            <div style="text-align:right">
              <div class="tag">${escapeHtml(p.status||'draft')}</div>
              <div style="margin-top:8px" class="actions">
                <button class="btn btn-ghost" data-action="view" data-id="${p.id}">View</button>
                <button class="btn btn-primary" data-action="load" data-id="${p.id}">Load</button>
              </div>
            </div>
          `;
          poList.appendChild(div);
        });

        poList.querySelectorAll('button[data-action="view"]').forEach(b => b.addEventListener('click', async (e) => {
          await viewPO(e.target.dataset.id);
        }));
        poList.querySelectorAll('button[data-action="load"]').forEach(b => b.addEventListener('click', async (e) => {
          await loadPOIntoForm(e.target.dataset.id);
        }));
      }catch(e){
        console.error(e); poList.innerHTML = 'Error loading POs';
      }
    }

    async function viewPO(id){
      const { data, error } = await supabase.from('purchase_orders').select('*').eq('id', id).single();
      if(error){ alert('Failed to fetch PO'); return; }
      const { data: itemsData } = await supabase.from('purchase_order_items').select('*').eq('purchase_order_id', id).order('item_no',{ascending:true});
      let txt = `PO: ${data.po_number}\nDate: ${data.po_date}\nFor: ${data.for_name}\nSupplier: ${data.supplier_name}\n\nItems:\n`;
      (itemsData || []).forEach((it, idx) => {
        txt += `${idx+1}. ${it.product_name} — ${it.quantity} ${it.unit} × ${moneyFmt(it.unit_price)} = ${moneyFmt(it.total)}\n`;
      });
      txt += `\nSubtotal: ${moneyFmt(data.subtotal)}\nTax: ${moneyFmt(data.tax)}\nFreight: ${moneyFmt(data.freight)}\nTotal: ${moneyFmt(data.final_total)}\n\nStatus: ${data.status}\nPrepared By: ${data.prepared_by}\nFinance: ${data.finance_checked_by}\nDirector: ${data.director_approved_by}\n\nRemarks:\n${data.remarks || ''}`;
      alert(txt);
    }

    async function loadPOIntoForm(id){
      const { data, error } = await supabase.from('purchase_orders').select('*').eq('id', id).single();
      if(error){ alert('Failed to load PO'); return; }
      const { data: itemsData } = await supabase.from('purchase_order_items').select('*').eq('purchase_order_id', id).order('item_no',{ascending:true});
      poNumberEl.value = data.po_number || '';
      poDateEl.value = data.po_date || new Date().toISOString().slice(0,10);
      forNameEl.value = data.for_name || '';
      supplierNameEl.value = data.supplier_name || '';
      supplierContactEl.value = data.supplier_contact || '';
      supplierAddressEl.value = data.supplier_address || '';
      remarksEl.value = data.remarks || '';
      preparedByEl.value = data.prepared_by || '';
      financeByEl.value = data.finance_checked_by || '';
      directorByEl.value = data.director_approved_by || '';
      statusEl.value = data.status || 'draft';
      preparedTimeEl.textContent = data.created_at ? new Date(data.created_at).toLocaleString() : '';
      financeTimeEl.textContent = data.finance_checked_by ? '(approved)' : '';
      directorTimeEl.textContent = data.director_approved_by ? '(approved)' : '';
      items = (itemsData || []).map(it => ({
        product_name: it.product_name,
        unit: it.unit,
        quantity: it.quantity,
        unit_price: it.unit_price
      }));
      renderItems();
      computeTotals();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ---------- Reset / initial ----------
    async function resetForm(){
      items = [];
      addItemRow();
      poNumberEl.value = '';
      poDateEl.value = new Date().toISOString().slice(0,10);
      forNameEl.value = '';
      supplierSelect.value = '';
      supplierNameEl.value = '';
      supplierContactEl.value = '';
      supplierAddressEl.value = '';
      remarksEl.value = '';
      taxPctEl.value = '0';
      freightEl.value = '0';
      preparedByEl.value = '';
      financeByEl.value = '';
      directorByEl.value = '';
      preparedTimeEl.textContent = '';
      financeTimeEl.textContent = '';
      directorTimeEl.textContent = '';
      statusEl.value = 'draft';
      computeTotals();
    }
  </script>
</body>
</html>
